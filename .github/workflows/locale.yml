name: getfem-binder-auto-update
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron:  '0 0 * * *'
jobs:
  script:
    runs-on: ubuntu-latest
    steps:
    - name: Get Job URL
      uses: Tiryoh/gha-jobid-action@v0
      id: jobs
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        job_name: script
    - name: checkout
      uses: actions/checkout@master
      with:
        token: ${{ secrets.PERSONAL_ACCESSTOKEN }}
        ref: ${{ github.ref }}
    - name: Setup SSH
      uses: MrSquaare/ssh-setup-action@v1
      with:
        host: github.com
        private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    - name: install
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends pandoc
        pip install -r requirements.txt
        git clone https://git.savannah.nongnu.org/git/getfem.git
        sudo apt-get install -y --no-install-recommends automake
        sudo apt-get install -y --no-install-recommends libtool
        sudo apt-get install -y --no-install-recommends make
        sudo apt-get install -y --no-install-recommends g++
        sudo apt-get install -y --no-install-recommends libqd-dev
        sudo apt-get install -y --no-install-recommends libqhull-dev
        sudo apt-get install -y --no-install-recommends libmumps-seq-dev
        sudo apt-get install -y --no-install-recommends liblapack-dev
        sudo apt-get install -y --no-install-recommends libopenblas-dev
        sudo apt-get install -y --no-install-recommends libpython3-dev
        sudo apt-get install -y --no-install-recommends imagemagick
        sudo apt-get install -y --no-install-recommends fig2dev
        sudo apt-get install -y --no-install-recommends texlive
        sudo apt-get install -y --no-install-recommends xzdec
        sudo apt-get install -y --no-install-recommends fig2ps
        sudo apt-get install -y --no-install-recommends gv
        sudo apt-get install -y --no-install-recommends python3-pip
        sudo apt-get install -y --no-install-recommends python3-venv
        python3 -m venv ./venv
        source ./venv/bin/activate 
        cd getfem 
        pip install --no-cache --upgrade pip 
        pip install -r requirements.txt 
        bash autogen.sh
        ./configure --prefix=/venv --with-pic 
        make -j8 
        make -j8 check
        make install
        cd interface
        make install
        deactivate
    - name: update
      env:
        SPHINXINTL_TRANSIFEX_USERNAME: api
        SPHINXINTL_TRANSIFEX_PROJECT_NAME: getfem-binder
        TX_TOKEN: ${{ secrets.TX_TOKEN }}
      run: |
        source /venv/bin/activate 
        sh ./locale/update.sh
        deactivate
    - name: git_config
      run: |
        git config --global user.email $GITHUB_REPOSITORY
        git config --global user.name $GITHUB_REPOSITORY
    - name: commit
      if: contains(github.event.head_commit.message, '[ci skip]') == false && contains(github.ref, 'master')
      env:
        JOB_ID: ${{ steps.jobs.outputs.job_id }}
        HTML_URL: ${{ steps.jobs.outputs.html_url }}
      run: |
        git fetch origin -p
        git checkout master
        git add .
        git commit --allow-empty -m "[ci skip] $JOB_ID
        $HTML_URL"
        git push origin master
